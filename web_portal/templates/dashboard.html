<!DOCTYPE html>
<html lang="en" class="bg-black">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barbossa Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'mono': ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        'terminal': '#00ff00',
                        'terminal-dim': '#00aa00',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* Minimal terminal effects */
        body { 
            text-shadow: 0 0 2px rgba(0, 255, 0, 0.5);
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Scanline effect */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            z-index: 1;
            background-size: 100% 2px;
            pointer-events: none;
            animation: scanline 8s linear infinite;
        }
        
        @keyframes scanline {
            0% { transform: translateY(0); }
            100% { transform: translateY(10px); }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #000;
            border: 1px solid #00ff00;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #00ff00;
            border: 1px solid #000;
        }
        
        .terminal-border {
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.1), inset 0 0 20px rgba(0, 255, 0, 0.05);
        }
        
        .glow-text {
            text-shadow: 0 0 5px currentColor;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 50;
        }
    </style>
</head>
<body class="bg-black text-terminal min-h-screen relative">
    <!-- Header -->
    <header class="sticky top-0 z-40 bg-black border-b border-terminal/30 px-4 py-2">
        <div class="flex justify-between items-center">
            <h1 class="text-lg font-bold uppercase tracking-wider glow-text">
                ▓ BARBOSSA CONTROL CENTER ▓
            </h1>
            <div class="flex gap-4 text-xs">
                <span class="px-2 py-1 border border-terminal" id="status-badge">ONLINE</span>
                <span class="text-terminal-dim" id="timestamp"></span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="sticky top-12 z-30 bg-black border-b border-terminal/20 px-4 py-1">
        <div class="flex gap-2 text-xs">
            <a href="/" class="px-3 py-1 border border-terminal bg-terminal/10 hover:bg-terminal/20 transition-colors uppercase">Dashboard</a>
            <a href="/workflows" class="px-3 py-1 border border-terminal/50 hover:bg-terminal/10 transition-colors uppercase">Workflows</a>
            <a href="/logs" class="px-3 py-1 border border-terminal/50 hover:bg-terminal/10 transition-colors uppercase">Logs</a>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="relative z-10 p-4">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 max-w-full">
            
            <!-- Barbossa Status -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Barbossa Status
                </h2>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div class="bg-terminal/5 border border-terminal/30 p-2 text-center">
                        <div class="text-base font-bold" id="barbossa-status">-</div>
                        <div class="text-terminal-dim text-[10px] uppercase mt-1">Status</div>
                    </div>
                    <div class="bg-terminal/5 border border-terminal/30 p-2 text-center">
                        <div class="text-base font-bold" id="next-run">-</div>
                        <div class="text-terminal-dim text-[10px] uppercase mt-1">Next Run</div>
                    </div>
                    <div class="bg-terminal/5 border border-terminal/30 p-2 text-center col-span-2">
                        <div class="text-base font-bold" id="claude-count">0</div>
                        <div class="text-terminal-dim text-[10px] uppercase mt-1">Claude Active</div>
                    </div>
                </div>
                
                <!-- Work Tally -->
                <div class="mt-3 pt-2 border-t border-terminal/20">
                    <div class="text-[10px] text-terminal-dim uppercase mb-2">Work Distribution</div>
                    <div id="work-tally" class="space-y-1">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mt-3 pt-2 border-t border-terminal/20">
                    <div class="grid grid-cols-2 gap-1">
                        <button onclick="triggerBarbossa('infrastructure')" 
                            class="text-[10px] px-2 py-1 border border-terminal bg-terminal/10 hover:bg-terminal/20 transition-colors uppercase">
                            Infra
                        </button>
                        <button onclick="triggerBarbossa('personal_projects')" 
                            class="text-[10px] px-2 py-1 border border-terminal bg-terminal/10 hover:bg-terminal/20 transition-colors uppercase">
                            Projects
                        </button>
                        <button onclick="triggerBarbossa('davy_jones')" 
                            class="text-[10px] px-2 py-1 border border-terminal bg-terminal/10 hover:bg-terminal/20 transition-colors uppercase">
                            Davy
                        </button>
                        <button onclick="triggerBarbossa()" 
                            class="text-[10px] px-2 py-1 border border-terminal bg-terminal/10 hover:bg-terminal/20 transition-colors uppercase">
                            Auto
                        </button>
                    </div>
                </div>
            </div>

            <!-- System Health -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    System Health
                </h2>
                <div class="space-y-2 text-xs font-mono">
                    <div class="flex justify-between">
                        <span class="text-terminal-dim">CPU:</span>
                        <span id="cpu-usage">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-terminal-dim">Memory:</span>
                        <span id="memory-usage">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-terminal-dim">Disk:</span>
                        <span id="disk-usage">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-terminal-dim">Network:</span>
                        <span id="network-status">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-terminal-dim">Uptime:</span>
                        <span id="uptime">--</span>
                    </div>
                </div>
            </div>

            <!-- Services Status -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Services
                </h2>
                <div id="services-list" class="space-y-1 text-xs">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Claude Processes -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Claude Processes
                </h2>
                <div id="claude-processes" class="space-y-1 text-xs max-h-40 overflow-y-auto">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Custom Prompt Interface (Full Width) -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border md:col-span-2 lg:col-span-3 xl:col-span-4">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Custom Prompt Interface
                </h2>
                <div class="grid md:grid-cols-2 gap-3">
                    <div>
                        <textarea id="custom-prompt" 
                            placeholder="Enter task description..." 
                            class="w-full h-20 bg-black border border-terminal/50 text-terminal text-xs p-2 font-mono placeholder-terminal/30 focus:border-terminal focus:outline-none resize-none">
                        </textarea>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <select id="custom-repository" 
                                class="bg-black border border-terminal/50 text-terminal text-xs p-1 focus:border-terminal focus:outline-none">
                                <option value="">No specific repository</option>
                                <!-- Populated by JS -->
                            </select>
                            <select id="task-type" 
                                class="bg-black border border-terminal/50 text-terminal text-xs p-1 focus:border-terminal focus:outline-none">
                                <option value="custom">Custom Task</option>
                                <option value="feature">Feature Development</option>
                                <option value="bugfix">Bug Fix</option>
                                <option value="refactor">Refactoring</option>
                                <option value="testing">Testing</option>
                                <option value="documentation">Documentation</option>
                            </select>
                        </div>
                        <button onclick="submitCustomPrompt()" 
                            class="mt-2 w-full text-xs px-3 py-2 border border-terminal bg-terminal/10 hover:bg-terminal/20 transition-colors uppercase font-bold">
                            Execute Task
                        </button>
                    </div>
                    <div>
                        <div class="text-[10px] text-terminal-dim uppercase mb-2">Active Sessions</div>
                        <div id="sessions-list" class="space-y-1 max-h-32 overflow-y-auto">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Logs -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border md:col-span-2">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Recent Activity
                </h2>
                <div id="recent-logs" class="space-y-1 text-xs font-mono max-h-48 overflow-y-auto">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Security Status -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Security
                </h2>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between">
                        <span class="text-terminal-dim">Violations:</span>
                        <span id="security-violations">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-terminal-dim">Last Audit:</span>
                        <span id="last-audit" class="text-[10px]">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-terminal-dim">Status:</span>
                        <span class="text-terminal">SECURE</span>
                    </div>
                </div>
            </div>

            <!-- Docker Containers -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Docker
                </h2>
                <div id="docker-containers" class="space-y-1 text-xs max-h-40 overflow-y-auto">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Backup Status -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Backups
                </h2>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between">
                        <span class="text-terminal-dim">Last Backup:</span>
                        <span id="last-backup" class="text-[10px]">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-terminal-dim">Total Size:</span>
                        <span id="backup-size">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-terminal-dim">Count:</span>
                        <span id="backup-count">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Projects -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Projects
                </h2>
                <div id="projects-list" class="space-y-1 text-xs max-h-40 overflow-y-auto">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Workflows -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Workflows
                </h2>
                <div id="workflows-list" class="space-y-1 text-xs max-h-40 overflow-y-auto">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Performance Analytics -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border md:col-span-2">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Performance
                </h2>
                <div class="grid grid-cols-3 gap-2 text-xs">
                    <div class="text-center">
                        <div class="text-lg font-bold" id="avg-response-time">--</div>
                        <div class="text-[10px] text-terminal-dim">Avg Response</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold" id="request-rate">--</div>
                        <div class="text-[10px] text-terminal-dim">Req/s</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-bold" id="error-rate">--</div>
                        <div class="text-[10px] text-terminal-dim">Error Rate</div>
                    </div>
                </div>
            </div>
            
            <!-- System Anomalies -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Anomalies
                </h2>
                <div id="anomalies-list" class="space-y-1 text-xs max-h-32 overflow-y-auto">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Integrations Status -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Integrations
                </h2>
                <div id="integrations-list" class="space-y-1 text-xs">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- GitHub Repos -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    GitHub
                </h2>
                <div id="github-repos" class="space-y-1 text-xs max-h-32 overflow-y-auto">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Optimization Suggestions -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border md:col-span-2 lg:col-span-3">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Optimizations
                </h2>
                <div id="optimization-suggestions" class="space-y-1 text-xs max-h-32 overflow-y-auto">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Webhooks -->
            <div class="border border-terminal bg-black/90 p-3 terminal-border">
                <h2 class="text-xs font-bold uppercase tracking-wider mb-3 pb-1 border-b border-terminal/50 glow-text">
                    Webhooks
                </h2>
                <div id="webhooks-list" class="space-y-1 text-xs max-h-32 overflow-y-auto">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for log viewing -->
    <div id="logModal" class="modal">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-black border-2 border-terminal w-full max-w-4xl max-h-[80vh] overflow-hidden">
                <div class="flex justify-between items-center p-3 border-b border-terminal">
                    <h3 class="text-sm font-bold uppercase">Log Viewer</h3>
                    <button onclick="closeModal()" class="text-terminal hover:text-white text-xl">&times;</button>
                </div>
                <div id="modal-log-content" class="p-4 overflow-y-auto max-h-[70vh] font-mono text-xs">
                    <!-- Log content here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = {};
        let currentSessionId = null;
        let sessionOutputOffset = 0;
        
        // Load allowed repositories on page load
        async function loadAllowedRepositories() {
            try {
                const response = await fetch('/api/barbossa/allowed-repositories');
                const result = await response.json();
                
                if (result.success) {
                    const repoSelect = document.getElementById('custom-repository');
                    while (repoSelect.options.length > 1) {
                        repoSelect.remove(1);
                    }
                    
                    result.repositories.forEach(repo => {
                        const option = document.createElement('option');
                        option.value = repo.url;
                        option.textContent = repo.name;
                        option.title = repo.full_name;
                        repoSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading repositories:', error);
            }
        }
        
        // Custom Prompt Functions
        async function submitCustomPrompt() {
            const promptText = document.getElementById('custom-prompt').value.trim();
            const repository = document.getElementById('custom-repository').value;
            const taskType = document.getElementById('task-type').value;
            
            if (!promptText) {
                alert('Please enter a task description');
                return;
            }
            
            try {
                const response = await fetch('/api/barbossa/custom-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: promptText,
                        repository: repository || null,
                        task_type: taskType
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(`✅ Session ${result.session_id} started`);
                    document.getElementById('custom-prompt').value = '';
                    document.getElementById('custom-repository').value = '';
                    currentSessionId = result.session_id;
                    await refreshSessions();
                    startSessionMonitoring(result.session_id);
                } else {
                    alert(`❌ Error: ${result.error}`);
                }
            } catch (error) {
                alert(`❌ Error: ${error.message}`);
            }
        }
        
        async function refreshSessions() {
            try {
                const response = await fetch('/api/barbossa/sessions?limit=5');
                const result = await response.json();
                
                if (result.success) {
                    const sessionsList = document.getElementById('sessions-list');
                    sessionsList.innerHTML = '';
                    
                    if (result.sessions.length === 0) {
                        sessionsList.innerHTML = '<div class="text-terminal-dim text-[10px]">No active sessions</div>';
                    } else {
                        result.sessions.forEach(session => {
                            const statusColor = session.status === 'running' ? 'text-yellow-500' : 
                                              session.status === 'completed' ? 'text-terminal' : 'text-red-500';
                            
                            const sessionDiv = document.createElement('div');
                            sessionDiv.className = 'flex justify-between items-center p-1 bg-terminal/5 border border-terminal/20';
                            sessionDiv.innerHTML = `
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] text-terminal-dim">ID:</span>
                                    <span class="text-[10px]">${session.id}</span>
                                    <span class="${statusColor} text-[10px] uppercase">[${session.status}]</span>
                                </div>
                                <div class="flex gap-1">
                                    ${session.status === 'running' ? 
                                        `<button onclick="viewSessionOutput('${session.id}')" class="text-[10px] px-1 border border-terminal/50 hover:bg-terminal/10">VIEW</button>
                                         <button onclick="terminateSession('${session.id}')" class="text-[10px] px-1 border border-red-500/50 hover:bg-red-500/10 text-red-500">KILL</button>` : 
                                        `<button onclick="viewSessionOutput('${session.id}')" class="text-[10px] px-1 border border-terminal/50 hover:bg-terminal/10">VIEW</button>`}
                                </div>
                            `;
                            sessionsList.appendChild(sessionDiv);
                        });
                    }
                }
            } catch (error) {
                console.error('Error fetching sessions:', error);
            }
        }
        
        async function viewSessionOutput(sessionId) {
            try {
                const response = await fetch(`/api/barbossa/session/${sessionId}`);
                const result = await response.json();
                
                if (result.success) {
                    const modal = document.getElementById('logModal');
                    const content = document.getElementById('modal-log-content');
                    content.innerHTML = `<pre class="text-terminal">${result.output || 'No output yet...'}</pre>`;
                    modal.style.display = 'block';
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function terminateSession(sessionId) {
            if (!confirm(`Terminate session ${sessionId}?`)) return;
            
            try {
                const response = await fetch(`/api/barbossa/session/${sessionId}/terminate`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    await refreshSessions();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        function startSessionMonitoring(sessionId) {
            sessionOutputOffset = 0;
            const monitorInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/barbossa/session/${sessionId}/stream?offset=${sessionOutputOffset}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        sessionOutputOffset = result.offset;
                        
                        if (result.completed) {
                            clearInterval(monitorInterval);
                            await refreshSessions();
                        }
                    }
                } catch (error) {
                    console.error('Error monitoring session:', error);
                    clearInterval(monitorInterval);
                }
            }, 5000);
        }
        
        async function fetchData() {
            try {
                const responses = await Promise.allSettled([
                    fetch('/api/status').then(r => r.ok ? r.json() : Promise.reject('Status failed')),
                    fetch('/api/changelogs').then(r => r.ok ? r.json() : Promise.reject('Changelogs failed')),
                    fetch('/api/security').then(r => r.ok ? r.json() : Promise.reject('Security failed')),
                    fetch('/api/claude').then(r => r.ok ? r.json() : Promise.reject('Claude failed')),
                    fetch('/api/services').then(r => r.ok ? r.json() : Promise.reject('Services failed')),
                    fetch('/api/network-status').then(r => r.ok ? r.json() : Promise.reject('Network failed')),
                    fetch('/api/backup-status').then(r => r.ok ? r.json() : Promise.reject('Backup failed')),
                    fetch('/api/comprehensive-status').then(r => r.ok ? r.json() : Promise.reject('Comprehensive failed')),
                    fetch('/api/projects').then(r => r.ok ? r.json() : Promise.reject('Projects failed')),
                    fetch('/api/barbossa-status').then(r => r.ok ? r.json() : Promise.reject('Barbossa status failed')),
                    fetch('/api/logs/recent').then(r => r.ok ? r.json() : Promise.reject('Recent logs failed')),
                    fetch('/api/settings').then(r => r.ok ? r.json() : Promise.reject('Settings failed')),
                    fetch('/api/analytics/performance').then(r => r.ok ? r.json() : Promise.reject('Analytics failed')),
                    fetch('/api/monitoring/anomalies').then(r => r.ok ? r.json() : Promise.reject('Anomalies failed')),
                    fetch('/api/workflows').then(r => r.ok ? r.json() : Promise.reject('Workflows failed')),
                    fetch('/api/integrations').then(r => r.ok ? r.json() : Promise.reject('Integrations failed')),
                    fetch('/api/webhooks').then(r => r.ok ? r.json() : Promise.reject('Webhooks failed')),
                    fetch('/api/integrations/github/repos').then(r => r.ok ? r.json() : Promise.reject('GitHub repos failed')),
                    fetch('/api/integrations/docker/containers').then(r => r.ok ? r.json() : Promise.reject('Docker containers failed')),
                    fetch('/api/optimization/suggestions').then(r => r.ok ? r.json() : Promise.reject('Optimization failed'))
                ]);
                
                const [statusRes, changelogsRes, securityRes, claudeRes, servicesRes, networkRes, backupRes,
                       comprehensiveRes, projectsRes, barbossaStatusRes, recentLogsRes, settingsRes,
                       analyticsRes, anomaliesRes, workflowsRes, integrationsRes, webhooksRes,
                       githubReposRes, dockerContainersRes, optimizationRes] = responses;
                
                currentData = {
                    status: statusRes.status === 'fulfilled' ? statusRes.value : null,
                    changelogs: changelogsRes.status === 'fulfilled' ? changelogsRes.value : null,
                    security: securityRes.status === 'fulfilled' ? securityRes.value : null,
                    claude: claudeRes.status === 'fulfilled' ? claudeRes.value : null,
                    services: servicesRes.status === 'fulfilled' ? servicesRes.value : null,
                    network: networkRes.status === 'fulfilled' ? networkRes.value : null,
                    backup: backupRes.status === 'fulfilled' ? backupRes.value : null,
                    comprehensive: comprehensiveRes.status === 'fulfilled' ? comprehensiveRes.value : null,
                    projects: projectsRes.status === 'fulfilled' ? projectsRes.value : null,
                    barbossaStatus: barbossaStatusRes.status === 'fulfilled' ? barbossaStatusRes.value : null,
                    recentLogs: recentLogsRes.status === 'fulfilled' ? recentLogsRes.value : null,
                    settings: settingsRes.status === 'fulfilled' ? settingsRes.value : null,
                    analytics: analyticsRes.status === 'fulfilled' ? analyticsRes.value : null,
                    anomalies: anomaliesRes.status === 'fulfilled' ? anomaliesRes.value : null,
                    workflows: workflowsRes.status === 'fulfilled' ? workflowsRes.value : null,
                    integrations: integrationsRes.status === 'fulfilled' ? integrationsRes.value : null,
                    webhooks: webhooksRes.status === 'fulfilled' ? webhooksRes.value : null,
                    githubRepos: githubReposRes.status === 'fulfilled' ? githubReposRes.value : null,
                    dockerContainers: dockerContainersRes.status === 'fulfilled' ? dockerContainersRes.value : null,
                    optimization: optimizationRes.status === 'fulfilled' ? optimizationRes.value : null
                };
                
                console.log('Fetched all data:', currentData);
                updateDashboard();
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        
        function updateDashboard() {
            // Update Barbossa Status
            if (currentData.status) {
                // Check for barbossa data within status
                const barbossaData = currentData.status.barbossa || currentData.status;
                
                document.getElementById('barbossa-status').textContent = barbossaData.running ? 'RUNNING' : 'IDLE';
                document.getElementById('barbossa-status').className = barbossaData.running ? 
                    'text-base font-bold text-yellow-500' : 'text-base font-bold';
                
                // Handle next_run which might be just a time string like "12:00 UTC"
                let nextRunDisplay = 'N/A';
                if (barbossaData.next_run) {
                    // If it's a time string like "12:00 UTC", use it directly
                    if (typeof barbossaData.next_run === 'string' && barbossaData.next_run.includes(':')) {
                        nextRunDisplay = barbossaData.next_run;
                    } else {
                        // Otherwise try to parse as date
                        const nextRunDate = new Date(barbossaData.next_run);
                        nextRunDisplay = isNaN(nextRunDate.getTime()) ? barbossaData.next_run : nextRunDate.toLocaleTimeString();
                    }
                }
                document.getElementById('next-run').textContent = nextRunDisplay;
                
                // Update work tally
                const tallyDiv = document.getElementById('work-tally');
                tallyDiv.innerHTML = '';
                if (barbossaData.work_tally) {
                    Object.entries(barbossaData.work_tally).forEach(([area, count]) => {
                        const bar = document.createElement('div');
                        bar.className = 'flex justify-between items-center text-[10px]';
                        bar.innerHTML = `
                            <span class="text-terminal-dim">${area.replace(/_/g, ' ')}</span>
                            <span class="font-bold">${count}</span>
                        `;
                        tallyDiv.appendChild(bar);
                    });
                }
                
                // Update System Health
                const systemData = currentData.status.system || {};
                
                // Parse CPU usage from string like "%Cpu(s):  0.8 us,  0.4 sy..."
                if (systemData.cpu_usage) {
                    const cpuMatch = systemData.cpu_usage.match(/(\d+\.\d+)\s+us/);
                    const cpuPercent = cpuMatch ? parseFloat(cpuMatch[1]) : '--';
                    document.getElementById('cpu-usage').textContent = cpuPercent !== '--' ? `${cpuPercent}%` : '--';
                } else {
                    document.getElementById('cpu-usage').textContent = '--';
                }
                
                // Parse memory from object {free: "14Gi", total: "30Gi", used: "2.1Gi"}
                if (systemData.memory) {
                    const used = systemData.memory.used || '--';
                    const total = systemData.memory.total || '--';
                    document.getElementById('memory-usage').textContent = `${used} / ${total}`;
                } else {
                    document.getElementById('memory-usage').textContent = '--';
                }
                
                // Parse disk from object {available: "3.4T", percent: "2%", total: "3.6T", used: "50G"}
                if (systemData.disk) {
                    document.getElementById('disk-usage').textContent = systemData.disk.percent || '--';
                } else {
                    document.getElementById('disk-usage').textContent = '--';
                }
                
                document.getElementById('uptime').textContent = systemData.uptime || '--';
                
                // Update network status from network API
                if (currentData.network && currentData.network.status) {
                    const netStatus = currentData.network.status === 'online' ? 'ONLINE' : 
                                     currentData.network.status === 'degraded' ? 'DEGRADED' : 'OFFLINE';
                    document.getElementById('network-status').textContent = netStatus;
                    document.getElementById('network-status').className = 
                        netStatus === 'ONLINE' ? 'text-terminal' : 
                        netStatus === 'DEGRADED' ? 'text-yellow-500' : 'text-red-500';
                } else {
                    document.getElementById('network-status').textContent = 'ONLINE';
                }
            }
            
            // Update Claude Processes - check both APIs
            const claudeProcesses = currentData.claude?.processes || currentData.status?.barbossa?.claude_processes || [];
            const claudeCount = claudeProcesses.length;
            
            document.getElementById('claude-count').textContent = claudeCount.toString();
            const processList = document.getElementById('claude-processes');
            processList.innerHTML = '';
            
            if (claudeProcesses.length > 0) {
                claudeProcesses.forEach(proc => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-1 bg-terminal/5 border border-terminal/20';
                    item.innerHTML = `
                        <span class="text-[10px]">PID: ${proc.pid}</span>
                        <button onclick="killClaude(${proc.pid})" 
                            class="text-[10px] px-1 border border-red-500/50 hover:bg-red-500/10 text-red-500">
                            KILL
                        </button>
                    `;
                    processList.appendChild(item);
                });
            } else {
                processList.innerHTML = '<div class="text-terminal-dim text-[10px]">No active processes</div>';
            }
            
            // Update Services - combine all service types
            const services = currentData.services || {};
            const servicesList = document.getElementById('services-list');
            servicesList.innerHTML = '';
            
            // Combine docker, processes, and systemd services
            const allServices = [];
            
            // Add key services from processes
            if (services.processes) {
                Object.entries(services.processes).forEach(([key, info]) => {
                    if (key === 'barbossa_portal' || key === 'claude' || key === 'cloudflared') {
                        allServices.push({
                            name: info.name || key,
                            status: info.status,
                            type: 'process'
                        });
                    }
                });
            }
            
            // Add Docker status
            if (services.docker) {
                const dockerRunning = Object.keys(services.docker).length;
                allServices.push({
                    name: 'Docker',
                    status: dockerRunning > 0 ? `${dockerRunning} containers` : 'no containers',
                    type: 'docker'
                });
            }
            
            // Add tmux sessions
            if (services.tmux_sessions) {
                allServices.push({
                    name: 'Tmux',
                    status: `${services.tmux_sessions.length} sessions`,
                    type: 'tmux'
                });
            }
            
            if (allServices.length > 0) {
                allServices.forEach(service => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center';
                    const statusClass = service.status === 'active' || service.status.includes('container') || service.status.includes('session') ? 
                        'text-terminal' : 'text-red-500';
                    item.innerHTML = `
                        <span class="text-terminal-dim text-[10px]">${service.name}:</span>
                        <span class="${statusClass} text-[10px] uppercase">${service.status}</span>
                    `;
                    servicesList.appendChild(item);
                });
            } else {
                servicesList.innerHTML = '<div class="text-terminal-dim text-[10px]">No services data</div>';
            }
            
            // Update Recent Logs
            const changelogs = currentData.changelogs || currentData.status?.changelogs || [];
            if (changelogs.length > 0) {
                const logsList = document.getElementById('recent-logs');
                logsList.innerHTML = '';
                changelogs.slice(0, 10).forEach(log => {
                    const filename = log.filename || log;
                    const fileType = log.type || '';
                    const item = document.createElement('div');
                    item.className = 'text-[10px] text-terminal-dim hover:text-terminal cursor-pointer flex justify-between';
                    const typeClass = fileType === 'Claude Output' ? 'text-yellow-500' : 'text-terminal-dim';
                    item.innerHTML = `
                        <span onclick="viewLog('${filename}')" class="flex-1">▸ ${filename}</span>
                        <span class="${typeClass} text-[9px] ml-2">[${fileType}]</span>
                    `;
                    logsList.appendChild(item);
                });
            }
            
            // Update Security
            const security = currentData.security || currentData.status?.security || {};
            document.getElementById('security-violations').textContent = 
                security.violations?.length || security.violation_count || '0';
            document.getElementById('last-audit').textContent = 
                security.last_audit_time || security.last_audit || '--';
            
            // Update Docker Containers
            const docker = currentData.services?.docker || {};
            const dockerList = document.getElementById('docker-containers');
            dockerList.innerHTML = '';
            
            const dockerContainers = Object.entries(docker);
            if (dockerContainers.length > 0) {
                dockerContainers.slice(0, 5).forEach(([name, info]) => {
                    const item = document.createElement('div');
                    const statusClass = info.status === 'running' ? 'text-terminal' : 'text-red-500';
                    item.className = 'text-[10px] flex justify-between';
                    item.innerHTML = `
                        <span class="text-terminal-dim truncate">${name}</span>
                        <span class="${statusClass}">${info.full_status || info.status}</span>
                    `;
                    dockerList.appendChild(item);
                });
            } else {
                dockerList.innerHTML = '<div class="text-terminal-dim text-[10px]">No containers</div>';
            }
            
            // Update Backup Status
            if (currentData.backup) {
                if (currentData.backup.last_backup) {
                    const lastBackupDate = new Date(currentData.backup.last_backup);
                    document.getElementById('last-backup').textContent = 
                        isNaN(lastBackupDate.getTime()) ? currentData.backup.last_backup : lastBackupDate.toLocaleDateString();
                }
                const backupSize = currentData.backup.backup_size ? 
                    `${currentData.backup.backup_size.toFixed(2)} MB` : '--';
                document.getElementById('backup-size').textContent = backupSize;
                document.getElementById('backup-count').textContent = currentData.backup.backup_count || '0';
            }
            
            // Update Projects
            const projectsList = document.getElementById('projects-list');
            projectsList.innerHTML = '';
            const projectsData = currentData.projects?.projects || {};
            const projectEntries = Object.entries(projectsData);
            if (projectEntries.length > 0) {
                projectEntries.slice(0, 7).forEach(([key, project]) => {
                    const item = document.createElement('div');
                    const hasChanges = project.has_changes ? '●' : '○';
                    const changeClass = project.has_changes ? 'text-yellow-500' : 'text-terminal';
                    item.className = 'text-[10px] text-terminal-dim hover:text-terminal cursor-pointer flex justify-between';
                    item.innerHTML = `
                        <span class="truncate">${project.name}</span>
                        <span class="${changeClass}">${hasChanges}</span>
                    `;
                    projectsList.appendChild(item);
                });
            } else {
                projectsList.innerHTML = '<div class="text-terminal-dim text-[10px]">No projects</div>';
            }
            
            // Update Workflows
            const workflowsList = document.getElementById('workflows-list');
            workflowsList.innerHTML = '';
            const workflowsData = currentData.workflows?.workflows || {};
            const workflowEntries = Object.entries(workflowsData);
            if (workflowEntries.length > 0) {
                workflowEntries.slice(0, 5).forEach(([key, workflow]) => {
                    const item = document.createElement('div');
                    item.className = 'text-[10px] flex justify-between';
                    const statusClass = workflow.status === 'active' ? 'text-terminal' : 'text-yellow-500';
                    item.innerHTML = `
                        <span class="text-terminal-dim">${workflow.name || key}</span>
                        <span class="${statusClass}">${workflow.status || 'ready'}</span>
                    `;
                    workflowsList.appendChild(item);
                });
            } else {
                workflowsList.innerHTML = '<div class="text-terminal-dim text-[10px]">No active workflows</div>';
            }
            
            // Update Performance Analytics
            const analyticsData = currentData.analytics?.analytics || currentData.comprehensive?.metrics || {};
            if (analyticsData) {
                document.getElementById('avg-response-time').textContent = 
                    analyticsData.avg_response_time ? `${analyticsData.avg_response_time}ms` : 
                    analyticsData.cpu_percent ? `CPU: ${analyticsData.cpu_percent}%` : '--';
                document.getElementById('request-rate').textContent = 
                    analyticsData.request_rate || 
                    analyticsData.network_recv_mbps ? `${analyticsData.network_recv_mbps.toFixed(2)} Mbps` : '--';
                document.getElementById('error-rate').textContent = 
                    analyticsData.error_rate ? `${analyticsData.error_rate}%` : 
                    analyticsData.memory_percent ? `Mem: ${analyticsData.memory_percent}%` : '0%';
            }
            
            // Update Anomalies
            const anomaliesList = document.getElementById('anomalies-list');
            anomaliesList.innerHTML = '';
            const anomaliesData = currentData.anomalies?.anomalies || [];
            const anomaliesMessage = currentData.anomalies?.message || '';
            if (anomaliesData.length > 0) {
                anomaliesData.forEach(anomaly => {
                    const item = document.createElement('div');
                    item.className = 'text-[10px] text-yellow-500';
                    item.textContent = `⚠ ${anomaly.description || anomaly}`;
                    anomaliesList.appendChild(item);
                });
            } else if (anomaliesMessage) {
                anomaliesList.innerHTML = `<div class="text-terminal-dim text-[10px]">${anomaliesMessage}</div>`;
            } else {
                anomaliesList.innerHTML = '<div class="text-terminal text-[10px]">✓ System normal</div>';
            }
            
            // Update Integrations
            const integrationsList = document.getElementById('integrations-list');
            integrationsList.innerHTML = '';
            const integrationsData = currentData.integrations?.integrations || [];
            if (Array.isArray(integrationsData) && integrationsData.length > 0) {
                integrationsData.slice(0, 5).forEach(integration => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between text-[10px]';
                    const statusClass = integration.status === 'active' ? 'text-terminal' : 'text-red-500';
                    item.innerHTML = `
                        <span class="text-terminal-dim truncate">${integration.name}</span>
                        <span class="${statusClass}">${integration.status}</span>
                    `;
                    integrationsList.appendChild(item);
                });
            } else {
                integrationsList.innerHTML = '<div class="text-terminal-dim text-[10px]">No integrations</div>';
            }
            
            // Update GitHub Repos
            const githubRepos = document.getElementById('github-repos');
            githubRepos.innerHTML = '';
            if (currentData.githubRepos && currentData.githubRepos.repositories) {
                currentData.githubRepos.repositories.slice(0, 5).forEach(repo => {
                    const item = document.createElement('div');
                    item.className = 'text-[10px] text-terminal-dim hover:text-terminal';
                    item.textContent = `▸ ${repo.name || repo}`;
                    githubRepos.appendChild(item);
                });
            } else {
                githubRepos.innerHTML = '<div class="text-terminal-dim text-[10px]">No repos</div>';
            }
            
            // Update Optimization Suggestions
            const optimizationList = document.getElementById('optimization-suggestions');
            optimizationList.innerHTML = '';
            const optimizationData = currentData.optimization;
            if (optimizationData && optimizationData.suggestions && Array.isArray(optimizationData.suggestions)) {
                optimizationData.suggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    const priority = suggestion.priority || 'low';
                    const priorityClass = priority === 'high' ? 'text-red-500' : 
                                        priority === 'medium' ? 'text-yellow-500' : 'text-terminal-dim';
                    item.className = `text-[10px] ${priorityClass}`;
                    item.innerHTML = `[${priority.toUpperCase()}] ${suggestion.description || suggestion}`;
                    optimizationList.appendChild(item);
                });
            } else if (optimizationData === null) {
                optimizationList.innerHTML = '<div class="text-terminal-dim text-[10px]">No optimization data</div>';
            } else {
                optimizationList.innerHTML = '<div class="text-terminal text-[10px]">✓ System optimized</div>';
            }
            
            // Update Webhooks
            const webhooksList = document.getElementById('webhooks-list');
            webhooksList.innerHTML = '';
            const webhooksData = currentData.webhooks?.webhooks || {};
            const webhookEntries = Object.entries(webhooksData);
            if (webhookEntries.length > 0) {
                webhookEntries.slice(0, 5).forEach(([key, webhook]) => {
                    const item = document.createElement('div');
                    const statusClass = webhook.active ? 'text-terminal' : 'text-terminal-dim';
                    item.className = `text-[10px] ${statusClass}`;
                    item.textContent = `▸ ${webhook.name || key}`;
                    webhooksList.appendChild(item);
                });
            } else {
                webhooksList.innerHTML = '<div class="text-terminal-dim text-[10px]">No active webhooks</div>';
            }
            
            // Update timestamp
            document.getElementById('timestamp').textContent = new Date().toLocaleTimeString();
        }
        
        async function triggerBarbossa(area) {
            const data = area ? { work_area: area } : {};
            try {
                const response = await fetch('/api/trigger-barbossa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert(`✅ ${result.message}`);
                    setTimeout(fetchData, 2000);
                } else {
                    alert(`❌ Error: ${result.error}`);
                }
            } catch (error) {
                alert(`❌ Error: ${error.message}`);
            }
        }
        
        async function killClaude(pid) {
            if (!confirm(`Kill Claude process ${pid}?`)) return;
            
            try {
                const response = await fetch('/api/kill-claude', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pid })
                });
                const result = await response.json();
                if (result.success) {
                    setTimeout(fetchData, 1000);
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        async function viewLog(filename) {
            try {
                const response = await fetch(`/api/log/${filename}`);
                const result = await response.json();
                if (result.success) {
                    const modal = document.getElementById('logModal');
                    const content = document.getElementById('modal-log-content');
                    content.innerHTML = `<pre class="text-terminal whitespace-pre-wrap">${result.content}</pre>`;
                    modal.style.display = 'block';
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }
        
        function closeModal() {
            document.getElementById('logModal').style.display = 'none';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
            refreshSessions();
            loadAllowedRepositories();
            
            setInterval(() => {
                fetchData();
                refreshSessions();
            }, 30000);
        });
        
        // Close modal on click outside
        window.onclick = function(event) {
            const modal = document.getElementById('logModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>