name: "Project Deployment Workflow"
description: "Automated deployment workflow for Node.js/Python projects with testing and rollback"
version: "1.0"

# Workflow configuration
trigger_type: "manual"

# Global variables
variables:
  project_name: "example-project"
  repository_url: "https://github.com/ADWilkinson/${project_name}"
  branch: "main"
  deploy_env: "production"
  health_check_url: "http://localhost:3000/health"
  backup_enabled: true

# Notification settings
notifications:
  on_success:
    type: "log"
    message: "Deployment of ${project_name} completed successfully"
  on_failure:
    type: "log"
    message: "Deployment of ${project_name} failed"
    alert_level: "critical"

# Retry policy
retry_policy:
  max_retries: 1
  retry_delay: 60

# Workflow tasks
tasks:
  - id: "security_validation"
    name: "Validate Repository Access"
    type: "git_operation"
    operation: "validate_access"
    repository_url: "${repository_url}"
    timeout: 60

  - id: "pre_deployment_backup"
    name: "Create Pre-Deployment Backup"
    type: "backup_operation"
    dependencies: ["security_validation"]
    backup_type: "files"
    source: "/home/dappnode/barbossa-engineer/projects/${project_name}"
    destination: "/home/dappnode/backups/${project_name}_backup_${system.datetime}.tar.gz"
    timeout: 300
    condition: "${backup_enabled}"

  - id: "clone_or_update_repository"
    name: "Clone or Update Repository"
    type: "git_operation"
    dependencies: ["pre_deployment_backup"]
    operation: "clone_or_update"
    repository_url: "${repository_url}"
    branch: "${branch}"
    working_directory: "/home/dappnode/barbossa-engineer/projects"
    timeout: 300

  - id: "detect_project_type"
    name: "Detect Project Type and Dependencies"
    type: "python_script"
    dependencies: ["clone_or_update_repository"]
    script: |
      import os
      import json
      from pathlib import Path
      
      project_path = Path(f"/home/dappnode/barbossa-engineer/projects/${project_name}")
      
      # Detect project type
      if (project_path / "package.json").exists():
          project_type = "nodejs"
          config_file = "package.json"
      elif (project_path / "requirements.txt").exists():
          project_type = "python"
          config_file = "requirements.txt"
      elif (project_path / "Cargo.toml").exists():
          project_type = "rust"
          config_file = "Cargo.toml"
      else:
          project_type = "unknown"
          config_file = None
      
      # Output results
      outputs = {
          "project_type": project_type,
          "config_file": config_file,
          "project_path": str(project_path)
      }
      
      print(json.dumps(outputs))
    timeout: 60

  - id: "install_dependencies"
    name: "Install Project Dependencies"
    type: "shell_command"
    dependencies: ["detect_project_type"]
    command: |
      cd /home/dappnode/barbossa-engineer/projects/${project_name}
      
      if [ "${task.project_type}" = "nodejs" ]; then
        npm ci --production
      elif [ "${task.project_type}" = "python" ]; then
        pip install -r requirements.txt
      elif [ "${task.project_type}" = "rust" ]; then
        cargo build --release
      else
        echo "Unknown project type, skipping dependency installation"
      fi
    timeout: 600

  - id: "run_tests"
    name: "Run Project Tests"
    type: "shell_command"
    dependencies: ["install_dependencies"]
    command: |
      cd /home/dappnode/barbossa-engineer/projects/${project_name}
      
      if [ "${task.project_type}" = "nodejs" ]; then
        npm test
      elif [ "${task.project_type}" = "python" ]; then
        python -m pytest tests/ || python -m unittest discover tests/
      elif [ "${task.project_type}" = "rust" ]; then
        cargo test
      else
        echo "Unknown project type, skipping tests"
        exit 0
      fi
    timeout: 900
    continue_on_failure: false

  - id: "build_project"
    name: "Build Project for Production"
    type: "shell_command"
    dependencies: ["run_tests"]
    command: |
      cd /home/dappnode/barbossa-engineer/projects/${project_name}
      
      if [ "${task.project_type}" = "nodejs" ]; then
        npm run build || echo "No build script found"
      elif [ "${task.project_type}" = "python" ]; then
        python setup.py build || echo "No setup.py found"
      elif [ "${task.project_type}" = "rust" ]; then
        cargo build --release
      else
        echo "Unknown project type, skipping build"
      fi
    timeout: 600
    continue_on_failure: true

  - id: "stop_existing_service"
    name: "Stop Existing Service"
    type: "service_management"
    dependencies: ["build_project"]
    action: "stop"
    service_name: "${project_name}"
    service_type: "docker"
    timeout: 60
    continue_on_failure: true

  - id: "deploy_application"
    name: "Deploy Application"
    type: "shell_command"
    dependencies: ["stop_existing_service"]
    command: |
      cd /home/dappnode/barbossa-engineer/projects/${project_name}
      
      # Copy to deployment directory
      sudo mkdir -p /opt/${project_name}
      sudo cp -r . /opt/${project_name}/
      sudo chown -R ${maintenance_user}:${maintenance_user} /opt/${project_name}
      
      # Start service based on project type
      if [ "${task.project_type}" = "nodejs" ]; then
        # Use PM2 or systemd for Node.js
        cd /opt/${project_name}
        nohup npm start > /var/log/${project_name}.log 2>&1 &
      elif [ "${task.project_type}" = "python" ]; then
        # Use systemd for Python
        cd /opt/${project_name}
        nohup python app.py > /var/log/${project_name}.log 2>&1 &
      fi
      
      echo "Deployment completed"
    timeout: 300

  - id: "start_service"
    name: "Start Application Service"
    type: "service_management"
    dependencies: ["deploy_application"]
    action: "start"
    service_name: "${project_name}"
    service_type: "systemd"
    timeout: 60
    continue_on_failure: true

  - id: "wait_for_startup"
    name: "Wait for Application Startup"
    type: "wait"
    dependencies: ["start_service"]
    duration: 30

  - id: "health_check"
    name: "Post-Deployment Health Check"
    type: "health_check"
    dependencies: ["wait_for_startup"]
    checks:
      - type: "http"
        url: "${health_check_url}"
        expected_status: 200
      - type: "service"
        service_name: "${project_name}"
    timeout: 120
    max_retries: 3

  - id: "smoke_tests"
    name: "Run Smoke Tests"
    type: "shell_command"
    dependencies: ["health_check"]
    command: |
      cd /home/dappnode/barbossa-engineer/projects/${project_name}
      
      # Run basic smoke tests
      if [ -f "smoke_tests.sh" ]; then
        bash smoke_tests.sh
      elif [ "${task.project_type}" = "nodejs" ]; then
        npm run test:smoke || echo "No smoke tests found"
      else
        echo "No smoke tests configured"
      fi
    timeout: 300
    continue_on_failure: true

  - id: "update_deployment_status"
    name: "Update Deployment Status"
    type: "python_script"
    dependencies: ["smoke_tests"]
    script: |
      import json
      import datetime
      from pathlib import Path
      
      # Update deployment status
      status = {
          "project_name": "${project_name}",
          "deployment_date": datetime.datetime.now().isoformat(),
          "status": "deployed",
          "version": "${task.commit_hash}",
          "environment": "${deploy_env}",
          "health_check_url": "${health_check_url}"
      }
      
      # Save deployment status
      status_path = Path(f"/home/dappnode/barbossa-engineer/deployments/${project_name}_status.json")
      status_path.parent.mkdir(exist_ok=True)
      
      with open(status_path, 'w') as f:
          json.dump(status, f, indent=2)
      
      print(f"Deployment status updated: {status_path}")
    timeout: 60

# Rollback tasks (run if deployment fails)
rollback_tasks:
  - id: "stop_failed_deployment"
    name: "Stop Failed Deployment"
    type: "service_management"
    action: "stop"
    service_name: "${project_name}"
    service_type: "systemd"
    timeout: 60

  - id: "restore_backup"
    name: "Restore from Backup"
    type: "shell_command"
    command: |
      if [ -f "/home/dappnode/backups/${project_name}_backup_${system.datetime}.tar.gz" ]; then
        cd /home/dappnode/barbossa-engineer/projects
        rm -rf ${project_name}_failed
        mv ${project_name} ${project_name}_failed 2>/dev/null || true
        tar -xzf /home/dappnode/backups/${project_name}_backup_${system.datetime}.tar.gz
        echo "Backup restored"
      else
        echo "No backup found for rollback"
      fi
    timeout: 300

  - id: "restart_previous_version"
    name: "Restart Previous Version"
    type: "service_management"
    action: "start"
    service_name: "${project_name}"
    service_type: "systemd"
    timeout: 60