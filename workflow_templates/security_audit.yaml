name: "Security Audit Workflow"
description: "Comprehensive security audit including vulnerability scanning, access review, and compliance checks"
version: "1.0"

# Workflow configuration
trigger_type: "schedule"
schedule:
  cron: "0 3 * * 1"  # Weekly on Monday at 3 AM
  timezone: "UTC"

# Global variables
variables:
  audit_date: "${system.date}"
  report_dir: "/home/dappnode/barbossa-engineer/security_reports"
  admin_user: "dappnode"
  critical_services: ["ssh", "docker", "cloudflared"]

# Notification settings
notifications:
  on_success:
    type: "log"
    message: "Security audit completed successfully"
  on_failure:
    type: "log"
    message: "Security audit failed or found critical issues"
    alert_level: "critical"

# Retry policy
retry_policy:
  max_retries: 1
  retry_delay: 300

# Workflow tasks
tasks:
  - id: "create_audit_directory"
    name: "Create Audit Report Directory"
    type: "shell_command"
    command: "mkdir -p ${report_dir}/${audit_date}"
    timeout: 30

  - id: "system_information_gathering"
    name: "Gather System Information"
    type: "shell_command"
    dependencies: ["create_audit_directory"]
    command: |
      cd ${report_dir}/${audit_date}
      
      # System information
      uname -a > system_info.txt
      hostnamectl >> system_info.txt
      
      # Installed packages
      dpkg -l > installed_packages.txt
      
      # Running processes
      ps aux > running_processes.txt
      
      # Network connections
      ss -tulpn > network_connections.txt
      
      # Mounted filesystems
      mount > mounted_filesystems.txt
      
      echo "System information gathered"
    timeout: 120

  - id: "user_account_audit"
    name: "Audit User Accounts and Permissions"
    type: "shell_command"
    dependencies: ["system_information_gathering"]
    command: |
      cd ${report_dir}/${audit_date}
      
      # User accounts
      cat /etc/passwd > user_accounts.txt
      
      # Group memberships
      cat /etc/group > group_memberships.txt
      
      # Sudo configuration
      sudo cat /etc/sudoers > sudo_config.txt 2>/dev/null || echo "Cannot read sudoers" > sudo_config.txt
      
      # SSH authorized keys
      find /home -name ".ssh" -type d -exec find {} -name "authorized_keys" \; > ssh_keys_locations.txt
      
      # Failed login attempts
      grep "Failed password" /var/log/auth.log | tail -50 > failed_logins.txt 2>/dev/null || echo "No auth log" > failed_logins.txt
      
      echo "User account audit completed"
    timeout: 120

  - id: "file_permissions_audit"
    name: "Audit File Permissions and Ownership"
    type: "shell_command"
    dependencies: ["user_account_audit"]
    command: |
      cd ${report_dir}/${audit_date}
      
      # SUID/SGID files
      find / -perm /6000 -type f 2>/dev/null > suid_sgid_files.txt
      
      # World-writable files
      find / -perm -002 -type f 2>/dev/null | head -100 > world_writable_files.txt
      
      # Files without owner
      find / -nouser -o -nogroup 2>/dev/null | head -100 > orphaned_files.txt
      
      # Check important directories
      ls -la /etc/passwd /etc/shadow /etc/ssh/ > critical_file_permissions.txt 2>/dev/null
      
      echo "File permissions audit completed"
    timeout: 300

  - id: "network_security_audit"
    name: "Audit Network Security Configuration"
    type: "shell_command"
    dependencies: ["file_permissions_audit"]
    command: |
      cd ${report_dir}/${audit_date}
      
      # Open ports
      nmap -sT -O localhost > nmap_localhost.txt 2>/dev/null || echo "nmap not available" > nmap_localhost.txt
      
      # Firewall status
      sudo ufw status verbose > firewall_status.txt 2>/dev/null || echo "UFW not configured" > firewall_status.txt
      
      # iptables rules
      sudo iptables -L -n -v > iptables_rules.txt 2>/dev/null || echo "Cannot read iptables" > iptables_rules.txt
      
      # Network interfaces
      ip addr show > network_interfaces.txt
      
      # Routing table
      ip route > routing_table.txt
      
      echo "Network security audit completed"
    timeout: 180

  - id: "service_security_audit"
    name: "Audit Running Services Security"
    type: "shell_command"
    dependencies: ["network_security_audit"]
    command: |
      cd ${report_dir}/${audit_date}
      
      # Systemd services
      systemctl list-units --type=service --state=running > running_services.txt
      
      # Check critical services
      for service in ${critical_services}; do
        echo "=== $service ===" >> service_configs.txt
        systemctl show $service >> service_configs.txt
        echo "" >> service_configs.txt
      done
      
      # Docker containers
      docker ps -a > docker_containers.txt 2>/dev/null || echo "Docker not available" > docker_containers.txt
      
      # Check for unnecessary services
      systemctl list-unit-files --type=service --state=enabled > enabled_services.txt
      
      echo "Service security audit completed"
    timeout: 120

  - id: "log_analysis"
    name: "Analyze Security Logs"
    type: "shell_command"
    dependencies: ["service_security_audit"]
    command: |
      cd ${report_dir}/${audit_date}
      
      # Authentication logs
      grep -i "authentication failure" /var/log/auth.log | tail -20 > auth_failures.txt 2>/dev/null || echo "No auth failures" > auth_failures.txt
      
      # SSH connection attempts
      grep "sshd" /var/log/auth.log | grep -E "(Failed|Accepted)" | tail -50 > ssh_attempts.txt 2>/dev/null || echo "No SSH logs" > ssh_attempts.txt
      
      # Sudo usage
      grep "sudo" /var/log/auth.log | tail -20 > sudo_usage.txt 2>/dev/null || echo "No sudo logs" > sudo_usage.txt
      
      # System errors
      grep -i "error\|critical\|alert" /var/log/syslog | tail -30 > system_errors.txt 2>/dev/null || echo "No system errors" > system_errors.txt
      
      echo "Log analysis completed"
    timeout: 120

  - id: "vulnerability_scanning"
    name: "Basic Vulnerability Scanning"
    type: "shell_command"
    dependencies: ["log_analysis"]
    command: |
      cd ${report_dir}/${audit_date}
      
      # Check for available security updates
      apt list --upgradable 2>/dev/null | grep -i security > security_updates.txt || echo "No security updates" > security_updates.txt
      
      # Check for unattended upgrades
      cat /etc/apt/apt.conf.d/50unattended-upgrades > unattended_upgrades_config.txt 2>/dev/null || echo "Not configured" > unattended_upgrades_config.txt
      
      # Check kernel version
      uname -r > kernel_version.txt
      
      # Check for core dumps
      find /var/crash -name "*.crash" 2>/dev/null > core_dumps.txt || echo "No core dumps" > core_dumps.txt
      
      echo "Vulnerability scanning completed"
    timeout: 180

  - id: "barbossa_security_check"
    name: "Barbossa Security Configuration Check"
    type: "python_script"
    dependencies: ["vulnerability_scanning"]
    script: |
      import json
      import os
      from pathlib import Path
      
      audit_dir = Path("${report_dir}/${audit_date}")
      
      # Check Barbossa security configuration
      security_config = {
          "security_guard_active": False,
          "repository_whitelist_exists": False,
          "zkp2p_access_blocked": False,
          "security_violations_logged": False
      }
      
      # Check security guard
      barbossa_dir = Path("/home/dappnode/barbossa-engineer")
      if (barbossa_dir / "security_guard.py").exists():
          security_config["security_guard_active"] = True
      
      # Check repository whitelist
      if (barbossa_dir / "config" / "repository_whitelist.json").exists():
          security_config["repository_whitelist_exists"] = True
      
      # Check security logs
      security_log_dir = barbossa_dir / "security"
      if security_log_dir.exists():
          security_config["security_violations_logged"] = True
      
      # Save results
      with open(audit_dir / "barbossa_security_config.json", 'w') as f:
          json.dump(security_config, f, indent=2)
      
      print("Barbossa security check completed")
    timeout: 60

  - id: "compliance_check"
    name: "Basic Compliance Checks"
    type: "shell_command"
    dependencies: ["barbossa_security_check"]
    command: |
      cd ${report_dir}/${audit_date}
      
      # Password policy
      cat /etc/login.defs | grep -E "PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_WARN_AGE" > password_policy.txt
      
      # Check for common compliance requirements
      echo "=== Compliance Check ===" > compliance_check.txt
      
      # SSH configuration
      echo "SSH Configuration:" >> compliance_check.txt
      grep -E "PasswordAuthentication|PermitRootLogin|Protocol" /etc/ssh/sshd_config >> compliance_check.txt 2>/dev/null
      
      # Check if logging is enabled
      echo "" >> compliance_check.txt
      echo "Logging Configuration:" >> compliance_check.txt
      systemctl is-active rsyslog >> compliance_check.txt
      
      # Check for audit daemon
      echo "" >> compliance_check.txt
      echo "Audit Daemon:" >> compliance_check.txt
      systemctl is-active auditd >> compliance_check.txt 2>/dev/null || echo "auditd not installed" >> compliance_check.txt
      
      echo "Compliance check completed"
    timeout: 120

  - id: "generate_security_report"
    name: "Generate Comprehensive Security Report"
    type: "python_script"
    dependencies: ["compliance_check"]
    script: |
      import json
      import datetime
      from pathlib import Path
      import glob
      
      audit_dir = Path("${report_dir}/${audit_date}")
      
      # Generate comprehensive security report
      report = {
          "audit_date": "${audit_date}",
          "audit_timestamp": datetime.datetime.now().isoformat(),
          "system_info": {},
          "security_findings": [],
          "recommendations": [],
          "compliance_status": {},
          "file_summary": []
      }
      
      # List all generated files
      for file_path in audit_dir.glob("*.txt"):
          file_info = {
              "filename": file_path.name,
              "size_bytes": file_path.stat().st_size,
              "description": file_path.stem.replace("_", " ").title()
          }
          report["file_summary"].append(file_info)
      
      # Add basic findings
      report["security_findings"] = [
          "System information gathered and stored",
          "User accounts and permissions audited",
          "File permissions reviewed",
          "Network security configuration checked",
          "Service security audited",
          "Security logs analyzed",
          "Basic vulnerability scan completed",
          "Barbossa security configuration verified"
      ]
      
      # Add recommendations
      report["recommendations"] = [
          "Review failed login attempts regularly",
          "Monitor SUID/SGID files for changes",
          "Keep system packages updated",
          "Review enabled services periodically",
          "Maintain firewall rules",
          "Monitor SSH access patterns",
          "Regular security audit reviews"
      ]
      
      # Save comprehensive report
      with open(audit_dir / "security_audit_report.json", 'w') as f:
          json.dump(report, f, indent=2)
      
      # Create summary
      summary = f"""
Security Audit Summary - ${audit_date}
=====================================

Audit completed: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Files generated: {len(report['file_summary'])}
Findings: {len(report['security_findings'])}
Recommendations: {len(report['recommendations'])}

Report location: {audit_dir}

Review the individual files for detailed security information.
      """
      
      with open(audit_dir / "AUDIT_SUMMARY.txt", 'w') as f:
          f.write(summary)
      
      print(f"Security audit report generated: {audit_dir}")
      print("Review AUDIT_SUMMARY.txt for overview")
    timeout: 120

  - id: "archive_report"
    name: "Archive Security Report"
    type: "shell_command"
    dependencies: ["generate_security_report"]
    command: |
      cd ${report_dir}
      
      # Create compressed archive
      tar -czf security_audit_${audit_date}.tar.gz ${audit_date}/
      
      # Set secure permissions
      chmod 600 security_audit_${audit_date}.tar.gz
      
      # Clean up old reports (keep last 12)
      ls -t security_audit_*.tar.gz | tail -n +13 | xargs rm -f 2>/dev/null || true
      
      echo "Security audit archived: security_audit_${audit_date}.tar.gz"
    timeout: 120

# Cleanup tasks
cleanup_tasks:
  - id: "cleanup_temp_files"
    name: "Clean Up Temporary Files"
    type: "shell_command"
    command: "rm -f /tmp/security_audit_* 2>/dev/null || true"
    timeout: 30