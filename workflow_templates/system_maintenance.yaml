name: "System Maintenance Workflow"
description: "Comprehensive system maintenance including updates, cleanup, and health checks"
version: "1.0"

# Workflow configuration
trigger_type: "schedule"
schedule:
  cron: "0 2 * * 0"  # Weekly on Sunday at 2 AM
  timezone: "UTC"

# Global variables
variables:
  backup_dir: "/home/dappnode/backups"
  log_retention_days: 30
  maintenance_user: "dappnode"

# Notification settings
notifications:
  on_success:
    type: "log"
    message: "System maintenance completed successfully"
  on_failure:
    type: "log"
    message: "System maintenance failed"
    alert_level: "critical"

# Retry policy
retry_policy:
  max_retries: 2
  retry_delay: 300  # 5 minutes

# Workflow tasks
tasks:
  - id: "pre_maintenance_backup"
    name: "Create Pre-Maintenance Backup"
    type: "backup_operation"
    backup_type: "system"
    destination: "${backup_dir}/pre_maintenance_${system.date}.tar.gz"
    source: "/home/dappnode/barbossa-engineer"
    timeout: 600
    max_retries: 1

  - id: "system_health_check"
    name: "Pre-Maintenance Health Check"
    type: "health_check"
    dependencies: ["pre_maintenance_backup"]
    checks:
      - type: "disk"
        threshold: 85
      - type: "memory"
        threshold: 90
      - type: "service"
        service_name: "docker"
    continue_on_failure: false

  - id: "update_package_lists"
    name: "Update Package Lists"
    type: "shell_command"
    dependencies: ["system_health_check"]
    command: "sudo apt update"
    timeout: 300

  - id: "upgrade_packages"
    name: "Upgrade System Packages"
    type: "shell_command"
    dependencies: ["update_package_lists"]
    command: "sudo apt upgrade -y"
    timeout: 1800  # 30 minutes
    max_retries: 1

  - id: "autoremove_packages"
    name: "Remove Unused Packages"
    type: "shell_command"
    dependencies: ["upgrade_packages"]
    command: "sudo apt autoremove -y && sudo apt autoclean"
    timeout: 300

  - id: "docker_cleanup"
    name: "Docker System Cleanup"
    type: "shell_command"
    dependencies: ["autoremove_packages"]
    command: "docker system prune -f && docker volume prune -f"
    timeout: 600

  - id: "log_rotation"
    name: "Rotate and Compress Old Logs"
    type: "shell_command"
    dependencies: ["docker_cleanup"]
    command: |
      find /home/dappnode/barbossa-engineer/logs -name "*.log" -mtime +${log_retention_days} -exec gzip {} \;
      find /var/log -name "*.log" -size +100M -exec sudo logrotate -f /etc/logrotate.conf {} \;
    timeout: 300

  - id: "cleanup_temp_files"
    name: "Clean Temporary Files"
    type: "shell_command"
    dependencies: ["log_rotation"]
    command: |
      sudo rm -rf /tmp/* 2>/dev/null || true
      sudo rm -rf /var/tmp/* 2>/dev/null || true
      find /home/dappnode -name "*.tmp" -mtime +7 -delete 2>/dev/null || true
    timeout: 300

  - id: "update_git_repositories"
    name: "Update Git Repositories"
    type: "shell_command"
    dependencies: ["cleanup_temp_files"]
    command: |
      cd /home/dappnode/barbossa-engineer/projects
      for dir in */; do
        if [ -d "$dir/.git" ]; then
          echo "Updating $dir"
          cd "$dir"
          git fetch --all
          cd ..
        fi
      done
    timeout: 600
    continue_on_failure: true

  - id: "verify_services"
    name: "Verify Critical Services"
    type: "health_check"
    dependencies: ["update_git_repositories"]
    checks:
      - type: "service"
        service_name: "docker"
      - type: "service"
        service_name: "ssh"
      - type: "http"
        url: "http://localhost:8443/health"
        expected_status: 200
    timeout: 120

  - id: "security_audit"
    name: "Basic Security Audit"
    type: "shell_command"
    dependencies: ["verify_services"]
    command: |
      # Check for failed login attempts
      sudo grep "Failed password" /var/log/auth.log | tail -10
      
      # Check for listening ports
      ss -tulpn | grep LISTEN
      
      # Check disk usage
      df -h
      
      # Check memory usage
      free -h
    timeout: 300
    continue_on_failure: true

  - id: "generate_maintenance_report"
    name: "Generate Maintenance Report"
    type: "python_script"
    dependencies: ["security_audit"]
    script: |
      import json
      import datetime
      from pathlib import Path
      
      # Generate maintenance report
      report = {
          "maintenance_date": datetime.datetime.now().isoformat(),
          "tasks_completed": [],
          "system_status": "maintenance_completed",
          "next_maintenance": (datetime.datetime.now() + datetime.timedelta(days=7)).isoformat()
      }
      
      # Save report
      report_path = Path("${backup_dir}/maintenance_report_${system.date}.json")
      report_path.parent.mkdir(exist_ok=True)
      
      with open(report_path, 'w') as f:
          json.dump(report, f, indent=2)
      
      print(f"Maintenance report saved to {report_path}")
    timeout: 60

  - id: "post_maintenance_health_check"
    name: "Post-Maintenance Health Check"
    type: "health_check"
    dependencies: ["generate_maintenance_report"]
    checks:
      - type: "disk"
        threshold: 90
      - type: "memory"
        threshold: 90
      - type: "service"
        service_name: "docker"
      - type: "http"
        url: "http://localhost:8443/health"
        expected_status: 200
    timeout: 120

# Cleanup tasks (run even if workflow fails)
cleanup_tasks:
  - id: "cleanup_temp_maintenance_files"
    name: "Clean Up Temporary Maintenance Files"
    type: "shell_command"
    command: "rm -f /tmp/maintenance_* 2>/dev/null || true"
    timeout: 60